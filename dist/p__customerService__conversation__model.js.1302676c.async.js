(window["webpackJsonp"]=window["webpackJsonp"]||[]).push([[4],{LoIa:function(e,t,n){"use strict";n.r(t);n("miYZ");var s=n("tsqr"),a=n("gWZ8"),r=n.n(a),c=n("hxiM"),o=n.n(c),i=n("d6i3"),u=n.n(i),p=n("p0pE"),l=n.n(p),d=(n("/xke"),n("TeRw")),g=n("GIZZ"),y=n.n(g),m=n("zDPs"),f=n("3Unq"),h=n("7Qib"),b=n("2Taf"),v=n.n(b),k=n("sutq"),x=n.n(k),_=n("Ck6f"),S=n("yaad"),w=S["b"].ENTER,E=S["b"].HEART_BEAT,L=function e(){var t=this;v()(this,e),this.ws=null,this.timer=null,this.dispatch=null,this.baseMessage=null,this.socketConnet=function(e){t.baseMessage=e,t.ws&&t.ws.close(),t.ws=new x.a(_["ws_target"],null,{debug:!0,reconnectInterval:3e3}),t.ws.onopen=function(){console.log("msg:","open"),t.sendMessage({message:"\u5ba2\u670d\u4e0a\u7ebf",msg_type:w}),t.sendHeartbeat()},t.ws.onmessage=function(e){var n=JSON.parse(e.data);console.log("msg:",n),t.dispatch({type:"onMessage",payload:n})}},this.close=function(){t.ws&&t.ws.close(),t.timer&&clearInterval(t.timer)},this.sendMessage=function(e){t.ws&&t.ws.send(JSON.stringify(l()({},t.baseMessage,e)))},this.sendHeartbeat=function(){t.timer&&clearInterval(t.timer),t.timer=setInterval(function(){t.sendMessage({msg_type:E,message:"\u5fc3\u8df3\u6d88\u606f"})},1e4)}},I=new L,M=S["b"].ENTER,C=S["b"].NORMAL,R=S["b"].PULL_LIST,T=S["b"].SEARCH_LIST,N=S["b"].GET_MSG,A=S["b"].READ,O=S["b"].SWITCH_SERVICE,W=S["b"].NEW_CONVERSATION,G=S["b"].SERVICE_EXI,D=S["b"].SERVICE_ONLINE,K=S["b"].SERVICE_BUSY,V=S["a"].TEXT,P=S["c"].CUSTOMER_SERVICE,z=S["c"].CUSTOMER,H={company_id:"",person_type:P,person_id:"",person_name:"",person_head_picture:"",auth_key:"",type:0,message:"",msg_type:C,msg_content_type:V,status:0};t["default"]=y()(f["a"],{namespace:"conversation",subscriptions:{setup:function(e){var t=e.dispatch,n=e.history;n.listen(function(e){var n=e.pathname;Object(h["g"])("/customerService/conversation",n)&&(I.dispatch=t,d["a"].destroy())})}},state:{switchServiceModal:!1,hasScroll:!1,hasMoreMsg:!0,hasMoreConversation:!0,showSearchList:!1,sort_type:1,customerServiceStatus:3,user:{},msgList:[],page:1,page_size:50,customerList:[],activeKey:null,auth_key:""},effects:{socketInit:u.a.mark(function e(t,n){var s,a,r,c,o,i;return u.a.wrap(function(e){while(1)switch(e.prev=e.next){case 0:return t.payload,s=n.call,a=n.put,r=n.select,e.next=4,r(function(e){return e.app});case 4:return c=e.sent,o=c.user,e.next=8,a({type:"updateState",payload:{user:o}});case 8:return i={person_name:o.name,person_head_picture:o.avatar,person_id:o.id,company_id:o.company_id},e.next=11,s(I.socketConnet,l()({},H,i,{auth_key:m["a"].getToken()}));case 11:case"end":return e.stop()}},e)}),closeSocket:u.a.mark(function e(t,n){var s;return u.a.wrap(function(e){while(1)switch(e.prev=e.next){case 0:return t.payload,s=n.call,n.put,n.select,e.next=4,s(I.close);case 4:case"end":return e.stop()}},e)}),sendMessage:u.a.mark(function e(t,n){var s,a,r,c,o;return u.a.wrap(function(e){while(1)switch(e.prev=e.next){case 0:return s=t.payload,a=n.call,n.put,r=n.select,e.next=4,r(function(e){return e.conversation});case 4:return c=e.sent,o=c.activeKey,e.next=8,a(I.sendMessage,l()({key:o||""},s));case 8:case"end":return e.stop()}},e)}),onMessage:u.a.mark(function e(t,n){var a,c,i,p,g,y,m,f,h,b,v,k,x,_,S,w,E,L,I,G,D,K,V,P,H,U,q,J;return u.a.wrap(function(e){while(1)switch(e.prev=e.next){case 0:return a=t.payload,n.call,c=n.put,i=n.select,e.next=4,i(function(e){return e.conversation});case 4:p=e.sent,g=p.activeKey,y=p.customerList,m=p.msgList,f=p.sort_type,h=p.page_size,e.t0=a.msg_type,e.next=e.t0===M?13:e.t0===R?19:e.t0===T?19:e.t0===C?30:e.t0===W?30:e.t0===N?70:e.t0===A?97:e.t0===O?102:111;break;case 13:return e.next=15,c({type:"updateState",payload:{customerServiceStatus:a.person_status}});case 15:if(y.length){e.next=18;break}return e.next=18,c({type:"getCustomerList"});case 18:return e.abrupt("break",111);case 19:return b=[],b=a.msg_type===R?a.result.list:a.result,v=o()(y,b,"key"),k=null,!g&&v.length&&(k=v[0].key),e.next=26,c({type:"updateState",payload:{activeKey:k||g,customerList:v,hasMoreConversation:!(b.length<h)}});case 26:if(!k){e.next=29;break}return e.next=29,c({type:"getMsgList"});case 29:return e.abrupt("break",111);case 30:if(a.msg_type!==W){e.next=34;break}if(x=y.findIndex(function(e){return e.key===a.key}),!(x>=0)){e.next=34;break}return e.abrupt("return");case 34:if("#/customerService/conversation"!==window.location.hash&&d["a"].info({key:"key",message:"\u6d88\u606f\u901a\u77e5",description:"\u60a8\u6709\u65b0\u7684\u4f1a\u8bdd\u6d88\u606f\uff0c\u8bf7\u53ca\u65f6\u5904\u7406\u3002",duration:0}),g!==a.key){e.next=55;break}if(_=-1,a.msg_index&&(_=m.findIndex(function(e){return e.msg_index===a.msg_index})),-1===_&&a.uid&&(_=m.findIndex(function(e){return e.uid===a.uid})),!(_>=0)){e.next=43;break}m.splice(_,1,a),e.next=51;break;case 43:if(a.person_type!==z){e.next=48;break}return e.next=46,c({type:"read",payload:[a.msg_index]});case 46:S=y.findIndex(function(e){return e.key===a.key}),y.splice(S,1,l()({},y[S],a,{unread_msg_num:0}));case 48:return m.push(a),e.next=51,c({type:"updateState",payload:{hasScroll:!0}});case 51:return e.next=53,c({type:"updateState",payload:{msgList:r()(m),customerList:r()(y)}});case 53:e.next=69;break;case 55:return w=y.findIndex(function(e){return e.key===g}),E=y.findIndex(function(e){return e.key===a.key}),L=y[E],console.log("\u6536\u5230\u65b0\u6d88\u606f",E),E>=0?1===f?(console.log("\u6536\u5230\u65b0\u6d88\u606f",a),y.splice(E,1,l()({},L,a))):(y.splice(E,1),y.unshift(l()({},L,a))):y.unshift(a),I=y.findIndex(function(e){return e.key===g}),w!==I&&I>0&&(G=y.splice(I,1)[0],y.splice(w,0,G)),D=null,!g&&y.length&&(D=y[0].key),e.next=66,c({type:"updateState",payload:{customerList:r()(y),activeKey:D||g}});case 66:if(!D){e.next=69;break}return e.next=69,c({type:"getMsgList"});case 69:return e.abrupt("break",111);case 70:if(K=y.findIndex(function(e){return e.key===a.key}),!(K>=0)){e.next=78;break}if(V=y[K],0===V.unread_msg_num){e.next=78;break}return V.unread_msg_num=0,y.splice(K,1,V),e.next=78,c({type:"updateState",payload:{customerList:r()(y)}});case 78:if(!a.list.length){e.next=93;break}if(P=a.list.filter(function(e){return 0===e.status&&e.person_type===z}).map(function(e){return e.msg_index}),!P.length){e.next=83;break}return e.next=83,c({type:"read",payload:P});case 83:return H=!m.length,U=a.list.filter(function(e){return[1,2].includes(e.person_type)}),e.next=87,c({type:"updateState",payload:{msgList:[].concat(r()(U),r()(m)),hasMoreMsg:!0,hasScroll:H}});case 87:if(U.length){e.next=91;break}return m.length&&s["a"].info("\u6ca1\u6709\u66f4\u591a\u6d88\u606f\u4e86"),e.next=91,c({type:"updateState",payload:{hasMoreMsg:!1}});case 91:e.next=96;break;case 93:return m.length&&s["a"].info("\u6ca1\u6709\u66f4\u591a\u6d88\u606f\u4e86"),e.next=96,c({type:"updateState",payload:{hasMoreMsg:!1}});case 96:return e.abrupt("break",111);case 97:if(a.person_type!==z){e.next=101;break}return m.forEach(function(e){a.msg_ids.includes(e.msg_index)&&(e.status=1)}),e.next=101,c({type:"updateState",payload:{msgList:r()(m)}});case 101:return e.abrupt("break",111);case 102:return s["a"].info("\u5ba2\u670d\u8f6c\u79fb\u6210\u529f"),q=y.filter(function(e){return e.key!==g}),J=q.length&&q[0].key||null,e.next=107,c({type:"updateState",payload:{customerList:r()(q),msgList:[],activeKey:J,switchServiceModal:!1}});case 107:if(!J){e.next=110;break}return e.next=110,c({type:"getMsgList"});case 110:return e.abrupt("break",111);case 111:case"end":return e.stop()}},e)}),getCustomerList:u.a.mark(function e(t,n){var s,a,r,c,o,i,p,l,d;return u.a.wrap(function(e){while(1)switch(e.prev=e.next){case 0:return t.payload,n.call,s=n.put,a=n.select,e.next=4,a(function(e){return e.conversation});case 4:return r=e.sent,c=r.customerList,o=r.page_size,i=r.page,p=r.sort_type,l=c.length,d={msg_type:R,message:"\u62c9\u53d6\u5ba2\u6237",sort_type:p,page:i,page_size:o,key:l?c[l-1].key:""},e.next=13,s({type:"sendMessage",payload:d});case 13:case"end":return e.stop()}},e)}),serarchCustomer:u.a.mark(function e(t,n){var s,a,r;return u.a.wrap(function(e){while(1)switch(e.prev=e.next){case 0:return s=t.payload,n.call,a=n.put,n.select,e.next=4,a({type:"updateState",payload:{customerList:[],activeKey:"",msgList:[]}});case 4:return r={search_name:s.search_name,message:"\u641c\u7d22\u5ba2\u6237",msg_type:T},e.next=7,a({type:"sendMessage",payload:r});case 7:case"end":return e.stop()}},e)}),getMsgList:u.a.mark(function e(t,n){var s,a,r;return u.a.wrap(function(e){while(1)switch(e.prev=e.next){case 0:return s=t.payload,n.call,a=n.put,n.select,r={msg_type:N,message:"\u62c9\u53d6\u6d88\u606f",msg_index:s||0},e.next=5,a({type:"sendMessage",payload:r});case 5:case"end":return e.stop()}},e)}),read:u.a.mark(function e(t,n){var s,a,r;return u.a.wrap(function(e){while(1)switch(e.prev=e.next){case 0:return s=t.payload,n.call,a=n.put,n.select,r={msg_type:A,message:"\u6d88\u606f\u5df2\u8bfb",msg_ids:s},e.next=5,a({type:"sendMessage",payload:r});case 5:case"end":return e.stop()}},e)}),switchStatus:u.a.mark(function e(t,n){var s,a,r;return u.a.wrap(function(e){while(1)switch(e.prev=e.next){case 0:return s=t.payload,n.call,a=n.put,n.select,e.next=4,a({type:"updateState",payload:{customerServiceStatus:s}});case 4:r={msg_type:"",message:""},e.t0=s,e.next=1===e.t0?8:2===e.t0?11:0===e.t0?14:17;break;case 8:return r.msg_type=D,r.message="\u5ba2\u670d\u4e0a\u7ebf",e.abrupt("break",17);case 11:return r.msg_type=K,r.message="\u5ba2\u670d\u5fd9\u788c",e.abrupt("break",17);case 14:return r.msg_type=G,r.message="\u5ba2\u670d\u4e0b\u7ebf",e.abrupt("break",17);case 17:return e.next=19,a({type:"sendMessage",payload:r});case 19:case"end":return e.stop()}},e)}),switchService:u.a.mark(function e(t,n){var s,a,r;return u.a.wrap(function(e){while(1)switch(e.prev=e.next){case 0:return s=t.payload,n.call,a=n.put,n.select,r={msg_type:O,message:"\u5207\u6362\u5ba2\u670d",switch_service_id:s.switch_service_id,remarks:s.remarks},e.next=5,a({type:"sendMessage",payload:r});case 5:case"end":return e.stop()}},e)})},reducers:{}})},sutq:function(e,t,n){var s,a,r;(function(n,c){a=[],s=c,r="function"===typeof s?s.apply(t,a):s,void 0===r||(e.exports=r)})(0,function(){if("WebSocket"in window)return e.prototype.onopen=function(e){},e.prototype.onclose=function(e){},e.prototype.onconnecting=function(e){},e.prototype.onmessage=function(e){},e.prototype.onerror=function(e){},e.debugAll=!1,e.CONNECTING=WebSocket.CONNECTING,e.OPEN=WebSocket.OPEN,e.CLOSING=WebSocket.CLOSING,e.CLOSED=WebSocket.CLOSED,e;function e(t,n,s){var a={debug:!1,automaticOpen:!0,reconnectInterval:1e3,maxReconnectInterval:3e4,reconnectDecay:1.5,timeoutInterval:2e3,maxReconnectAttempts:null,binaryType:"blob"};for(var r in s||(s={}),a)"undefined"!==typeof s[r]?this[r]=s[r]:this[r]=a[r];this.url=t,this.reconnectAttempts=0,this.readyState=WebSocket.CONNECTING,this.protocol=null;var c,o=this,i=!1,u=!1,p=document.createElement("div");function l(e,t){var n=document.createEvent("CustomEvent");return n.initCustomEvent(e,!1,!1,t),n}p.addEventListener("open",function(e){o.onopen(e)}),p.addEventListener("close",function(e){o.onclose(e)}),p.addEventListener("connecting",function(e){o.onconnecting(e)}),p.addEventListener("message",function(e){o.onmessage(e)}),p.addEventListener("error",function(e){o.onerror(e)}),this.addEventListener=p.addEventListener.bind(p),this.removeEventListener=p.removeEventListener.bind(p),this.dispatchEvent=p.dispatchEvent.bind(p),this.open=function(t){if(c=new WebSocket(o.url,n||[]),c.binaryType=this.binaryType,t){if(this.maxReconnectAttempts&&this.reconnectAttempts>this.maxReconnectAttempts)return}else p.dispatchEvent(l("connecting")),this.reconnectAttempts=0;(o.debug||e.debugAll)&&console.debug("ReconnectingWebSocket","attempt-connect",o.url);var s=c,a=setTimeout(function(){(o.debug||e.debugAll)&&console.debug("ReconnectingWebSocket","connection-timeout",o.url),u=!0,s.close(),u=!1},o.timeoutInterval);c.onopen=function(n){clearTimeout(a),(o.debug||e.debugAll)&&console.debug("ReconnectingWebSocket","onopen",o.url),o.protocol=c.protocol,o.readyState=WebSocket.OPEN,o.reconnectAttempts=0;var s=l("open");s.isReconnect=t,t=!1,p.dispatchEvent(s)},c.onclose=function(n){if(clearTimeout(a),c=null,i)o.readyState=WebSocket.CLOSED,p.dispatchEvent(l("close"));else{o.readyState=WebSocket.CONNECTING;var s=l("connecting");s.code=n.code,s.reason=n.reason,s.wasClean=n.wasClean,p.dispatchEvent(s),t||u||((o.debug||e.debugAll)&&console.debug("ReconnectingWebSocket","onclose",o.url),p.dispatchEvent(l("close")));var a=o.reconnectInterval*Math.pow(o.reconnectDecay,o.reconnectAttempts);setTimeout(function(){o.reconnectAttempts++,o.open(!0)},a>o.maxReconnectInterval?o.maxReconnectInterval:a)}},c.onmessage=function(t){(o.debug||e.debugAll)&&console.debug("ReconnectingWebSocket","onmessage",o.url,t.data);var n=l("message");n.data=t.data,p.dispatchEvent(n)},c.onerror=function(t){(o.debug||e.debugAll)&&console.debug("ReconnectingWebSocket","onerror",o.url,t),p.dispatchEvent(l("error"))}},1==this.automaticOpen&&this.open(!1),this.send=function(t){if(c)return(o.debug||e.debugAll)&&console.debug("ReconnectingWebSocket","send",o.url,t),c.send(t);throw"INVALID_STATE_ERR : Pausing to reconnect websocket"},this.close=function(e,t){"undefined"==typeof e&&(e=1e3),i=!0,c&&c.close(e,t)},this.refresh=function(){c&&c.close()}}})}}]);